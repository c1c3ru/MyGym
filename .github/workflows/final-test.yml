name: Final Test

on:
  workflow_dispatch:

jobs:
  final-test:
    name: Final EAS Test
    runs-on: ubuntu-latest
    
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🏗 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
          cache: npm

      - name: 🏗 Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 🏗 Setup EAS CLI
        run: |
          echo "Installing EAS CLI..."
          npm install -g @expo/cli@latest eas-cli@latest
          echo "✅ EAS CLI installed successfully"

      - name: 🔑 Authenticate EAS
        run: |
          echo "Checking EAS authentication..."
          eas whoami
          echo "✅ EAS authentication successful"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: 📦 Install dependencies
        run: |
          echo "Installing project dependencies..."
          npm ci
          echo "✅ Dependencies installed successfully"

      - name: 🔧 Setup environment variables
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
        run: |
          echo "Setting up environment variables..."
          echo "EXPO_PUBLIC_FIREBASE_API_KEY=$FIREBASE_API_KEY" >> .env
          echo "EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN=$FIREBASE_AUTH_DOMAIN" >> .env
          echo "EXPO_PUBLIC_FIREBASE_PROJECT_ID=$FIREBASE_PROJECT_ID" >> .env
          echo "EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET=$FIREBASE_STORAGE_BUCKET" >> .env
          echo "EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=$FIREBASE_MESSAGING_SENDER_ID" >> .env
          echo "EXPO_PUBLIC_FIREBASE_APP_ID=$FIREBASE_APP_ID" >> .env
          echo "✅ Environment variables configured"

      - name: ✅ Run type check
        run: |
          echo "Running TypeScript type check..."
          npm run type-check
          echo "✅ Type check passed"

      - name: 🎨 Run lint
        run: |
          echo "Running ESLint..."
          npm run lint
          echo "✅ Lint passed"

      - name: 🔧 Check EAS project
        run: |
          echo "Checking EAS project configuration..."
          
          if [ -f "eas.json" ]; then
            echo "✅ eas.json found"
          else
            echo "❌ eas.json not found"
            exit 1
          fi
          
          if [ -f "app.json" ]; then
            echo "✅ app.json found"
          else
            echo "❌ app.json not found"
            exit 1
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: 🚀 Test EAS connectivity
        run: |
          echo "Testing EAS connectivity..."
          eas build:list --platform android --limit 1 --non-interactive || echo "No previous builds found (this is normal)"
          echo "✅ EAS connectivity test successful"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: 🎉 Success Summary
        run: |
          echo "🎉 ALL TESTS PASSED!"
          echo "================================"
          echo "✅ EAS CLI installed and working"
          echo "✅ Authentication successful"
          echo "✅ Dependencies installed"
          echo "✅ Environment variables configured"
          echo "✅ TypeScript check passed"
          echo "✅ Lint check passed"
          echo "✅ Project configuration valid"
          echo "✅ EAS connectivity confirmed"
          echo "================================"
          echo "🚀 READY FOR BUILD!"
          echo ""
          echo "Next step: Run Manual Build workflow"
